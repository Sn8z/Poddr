{"version":3,"file":"httpExecutor.js","sourceRoot":"","sources":["../src/httpExecutor.ts"],"names":[],"mappings":"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","sourcesContent":["import { createHash, Hash } from \"crypto\"\nimport _debug from \"debug\"\nimport { EventEmitter } from \"events\"\nimport { createWriteStream } from \"fs-extra-p\"\nimport { IncomingMessage, OutgoingHttpHeaders, RequestOptions } from \"http\"\nimport { Socket } from \"net\"\nimport { Transform } from \"stream\"\nimport { parse as parseUrl } from \"url\"\nimport { CancellationToken } from \"./CancellationToken\"\nimport { ProgressCallbackTransform, ProgressInfo } from \"./ProgressCallbackTransform\"\n\nexport { CancellationToken, CancellationError} from \"./CancellationToken\"\nexport { ProgressCallbackTransform, ProgressInfo } from \"./ProgressCallbackTransform\"\n\nconst debug = _debug(\"electron-builder\")\n\nexport interface RequestHeaders extends OutgoingHttpHeaders {\n  [key: string]: string\n}\n\n// tslint:disable:no-empty-interface\nexport interface RequestOptionsEx extends RequestOptions {\n}\n\nexport interface Response extends EventEmitter {\n  statusCode?: number\n  statusMessage?: string\n\n  headers: any\n\n  setEncoding(encoding: string): void\n}\n\nexport interface DownloadOptions {\n  readonly headers?: OutgoingHttpHeaders | null\n  readonly skipDirCreation?: boolean\n  readonly sha2?: string | null\n  readonly sha512?: string | null\n\n  readonly cancellationToken: CancellationToken\n\n  onProgress?(progress: ProgressInfo): void\n}\n\nexport class HttpError extends Error {\n  constructor(public readonly response: {statusMessage?: string | undefined, statusCode?: number | undefined, headers?: { [key: string]: Array<string>; } | undefined}, public description: any | null = null) {\n    super(response.statusCode + \" \" + response.statusMessage + (description == null ? \"\" : (\"\\n\" + JSON.stringify(description, null, \"  \"))) + \"\\nHeaders: \" + JSON.stringify(response.headers, null, \"  \"))\n\n    this.name = \"HttpError\"\n  }\n}\n\nexport function parseJson(result: Promise<string | null>) {\n  return result.then(it => it == null || it.length === 0 ? null : JSON.parse(it))\n}\n\nexport abstract class HttpExecutor<REQUEST> {\n  protected readonly maxRedirects = 10\n\n  request(options: RequestOptions, cancellationToken: CancellationToken = new CancellationToken(), data?: { [name: string]: any; } | null): Promise<string | null> {\n    configureRequestOptions(options)\n    const encodedData = data == null ? undefined : new Buffer(JSON.stringify(data))\n    if (encodedData != null) {\n      options.method = \"post\"\n      options.headers![\"Content-Type\"] = \"application/json\"\n      options.headers![\"Content-Length\"] = encodedData.length\n    }\n    return this.doApiRequest(options, cancellationToken, it => (it as any).end(encodedData), 0)\n  }\n\n  protected abstract doApiRequest(options: RequestOptions, cancellationToken: CancellationToken, requestProcessor: (request: REQUEST, reject: (error: Error) => void) => void, redirectCount: number): Promise<string>\n\n  protected handleResponse(response: Response, options: RequestOptionsEx, cancellationToken: CancellationToken, resolve: (data?: any) => void, reject: (error: Error) => void, redirectCount: number, requestProcessor: (request: REQUEST, reject: (error: Error) => void) => void) {\n    if (debug.enabled) {\n      debug(`Response status: ${response.statusCode} ${response.statusMessage}, request options: ${dumpRequestOptions(options)}`)\n    }\n\n    // we handle any other >= 400 error on request end (read detailed message in the response body)\n    if (response.statusCode === 404) {\n      // error is clear, we don't need to read detailed error description\n      reject(new HttpError(response, `method: ${options.method} url: https://${options.hostname}${options.path}\n\n    Please double check that your authentication token is correct. Due to security reasons actual status maybe not reported, but 404.\n    `))\n      return\n    }\n    else if (response.statusCode === 204) {\n      // on DELETE request\n      resolve()\n      return\n    }\n\n    const redirectUrl = safeGetHeader(response, \"location\")\n    if (redirectUrl != null) {\n      if (redirectCount > 10) {\n        reject(new Error(\"Too many redirects (> 10)\"))\n        return\n      }\n\n      const newUrl = parseUrl(redirectUrl)\n      this.doApiRequest({...options, ...newUrl as any}, cancellationToken, requestProcessor, redirectCount)\n        .then(resolve)\n        .catch(reject)\n      return\n    }\n\n    let data = \"\"\n    response.setEncoding(\"utf8\")\n    response.on(\"data\", (chunk: string) => {\n      data += chunk\n    })\n\n    response.on(\"end\", () => {\n      try {\n        const contentType = response.headers[\"content-type\"]\n        if (response.statusCode != null && response.statusCode >= 400) {\n          const isJson = contentType != null && (Array.isArray(contentType) ? contentType.find(it => it.includes(\"json\")) != null : contentType.includes(\"json\"))\n          reject(new HttpError(response, isJson ? JSON.parse(data) : data))\n        }\n        else {\n          resolve(data.length === 0 ? null : data)\n        }\n      }\n      catch (e) {\n        reject(e)\n      }\n    })\n  }\n\n  protected abstract doRequest(options: any, callback: (response: any) => void): any\n\n  protected doDownload(requestOptions: any, destination: string, redirectCount: number, options: DownloadOptions, callback: (error: Error | null) => void, onCancel: (callback: () => void) => void) {\n    const request = this.doRequest(requestOptions, (response: IncomingMessage) => {\n      if (response.statusCode! >= 400) {\n        callback(new Error(`Cannot download \"${requestOptions.protocol || \"https:\"}//${requestOptions.hostname}${requestOptions.path}\", status ${response.statusCode}: ${response.statusMessage}`))\n        return\n      }\n\n      const redirectUrl = safeGetHeader(response, \"location\")\n      if (redirectUrl != null) {\n        if (redirectCount < this.maxRedirects) {\n          this.doDownload(configureRequestOptionsFromUrl(redirectUrl, {...requestOptions}), destination, redirectCount++, options, callback, onCancel)\n        }\n        else {\n          callback(new Error(`Too many redirects (> ${this.maxRedirects})`))\n        }\n        return\n      }\n\n      configurePipes(options, response, destination, callback, options.cancellationToken)\n    })\n    this.addTimeOutHandler(request, callback)\n    request.on(\"error\", callback)\n    request.on(\"aborted\", () => {\n      callback(new Error(\"Request has been aborted by the server\"))\n    })\n    onCancel(() => request.abort())\n    request.end()\n  }\n\n  protected addTimeOutHandler(request: any, callback: (error: Error) => void) {\n    request.on(\"socket\", (socket: Socket) => {\n      socket.setTimeout(60 * 1000, () => {\n        callback(new Error(\"Request timed out\"))\n        request.abort()\n      })\n    })\n  }\n}\n\nexport function configureRequestOptionsFromUrl(url: string, options: RequestOptions) {\n  const parsedUrl = parseUrl(url)\n  options.protocol = parsedUrl.protocol\n  options.hostname = parsedUrl.hostname\n  if (parsedUrl.port == null) {\n    if (options.port != null) {\n      delete options.port\n    }\n  }\n  else {\n    options.port = parsedUrl.port\n  }\n  options.path = parsedUrl.path\n  return options\n}\n\nexport class DigestTransform extends Transform {\n  private readonly digester: Hash\n\n  constructor(private readonly expected: string, private readonly algorithm: string, private readonly encoding: \"hex\" | \"base64\" | \"latin1\") {\n    super()\n\n    this.digester = createHash(algorithm)\n  }\n\n  _transform(chunk: any, encoding: string, callback: any) {\n    this.digester.update(chunk)\n    callback(null, chunk)\n  }\n\n  _flush(callback: any): void {\n    const hash = this.digester.digest(this.encoding)\n    callback(hash === this.expected ? null : new Error(`${this.algorithm} checksum mismatch, expected ${this.expected}, got ${hash}`))\n  }\n}\n\nfunction checkSha2(sha2Header: string | null | undefined, sha2: string | null | undefined, callback: (error: Error | null) => void): boolean {\n  if (sha2Header != null && sha2 != null) {\n    // todo why bintray doesn't send this header always\n    if (sha2Header == null) {\n      callback(new Error(\"checksum is required, but server response doesn't contain X-Checksum-Sha2 header\"))\n      return false\n    }\n    else if (sha2Header !== sha2) {\n      callback(new Error(`checksum mismatch: expected ${sha2} but got ${sha2Header} (X-Checksum-Sha2 header)`))\n      return false\n    }\n  }\n  return true\n}\n\nexport function safeGetHeader(response: any, headerKey: string) {\n  const value = response.headers[headerKey]\n  if (value == null) {\n    return null\n  }\n  else if (Array.isArray(value)) {\n    // electron API\n    return value.length === 0 ? null : value[value.length - 1]\n  }\n  else {\n    return value\n  }\n}\n\nfunction configurePipes(options: DownloadOptions, response: any, destination: string, callback: (error: Error | null) => void, cancellationToken: CancellationToken) {\n  if (!checkSha2(safeGetHeader(response, \"X-Checksum-Sha2\"), options.sha2, callback)) {\n    return\n  }\n\n  const streams: Array<any> = []\n  if (options.onProgress != null) {\n    const contentLength = safeGetHeader(response, \"content-length\")\n    if (contentLength != null) {\n      streams.push(new ProgressCallbackTransform(parseInt(contentLength, 10), options.cancellationToken, options.onProgress))\n    }\n  }\n\n  const sha512 = options.sha512\n  if (sha512 != null) {\n    streams.push(new DigestTransform(sha512, \"sha512\", sha512.length === 128 && !sha512.includes(\"+\") && !sha512.includes(\"Z\") && !sha512.includes(\"=\") ? \"hex\" : \"base64\"))\n  }\n  else if (options.sha2 != null) {\n    streams.push(new DigestTransform(options.sha2, \"sha256\", \"hex\"))\n  }\n\n  const fileOut = createWriteStream(destination)\n  streams.push(fileOut)\n\n  let lastStream = response\n  for (const stream of streams) {\n    stream.on(\"error\", (error: Error) => {\n      if (!cancellationToken.cancelled) {\n        callback(error)\n      }\n    })\n    lastStream = lastStream.pipe(stream)\n  }\n\n  fileOut.on(\"finish\", () => {\n    (fileOut.close as any)(callback)\n  })\n}\n\nexport function configureRequestOptions(options: RequestOptions, token?: string | null, method?: \"GET\" | \"DELETE\" | \"PUT\"): RequestOptions {\n  if (method != null) {\n    options.method = method\n  }\n\n  let headers = options.headers\n  if (headers == null) {\n    headers = {}\n    options.headers = headers\n  }\n  if (token != null) {\n    (headers as any).authorization = token.startsWith(\"Basic\") ? token : `token ${token}`\n  }\n  if (headers[\"User-Agent\"] == null) {\n    headers[\"User-Agent\"] = \"electron-builder\"\n  }\n\n  if ((method == null || method === \"GET\") || headers[\"Cache-Control\"] == null) {\n    headers[\"Cache-Control\"] = \"no-cache\"\n  }\n\n  // do not specify for node (in any case we use https module)\n  if (options.protocol == null && (process.versions as any).electron != null) {\n    options.protocol = \"https:\"\n  }\n  return options\n}\n\nexport function dumpRequestOptions(options: RequestOptions): string {\n  const safe: any = {...options}\n  if (safe.headers != null && safe.headers.authorization != null) {\n    safe.headers.authorization = \"<skipped>\"\n  }\n  return JSON.stringify(safe, null, 2)\n}"]}
