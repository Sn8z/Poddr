{"version":3,"file":"PublishManager.js","sourceRoot":"","sources":["../../src/publish/PublishManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { hashFile } from \"asar-integrity\"\nimport BluebirdPromise from \"bluebird-lst\"\nimport { Arch, asArray, AsyncTaskManager, isEmptyOrSpaces, isPullRequest, log, safeStringifyJson, warn } from \"builder-util\"\nimport _debug from \"debug\"\nimport { CancellationToken } from \"electron-builder-http\"\nimport { BintrayOptions, GenericServerOptions, GithubOptions, githubUrl, PublishConfiguration, PublishProvider, S3Options, s3Url } from \"electron-builder-http/out/publishOptions\"\nimport { UpdateInfo } from \"electron-builder-http/out/updateInfo\"\nimport { getCiTag, HttpPublisher, PublishContext, Publisher, PublishOptions } from \"electron-publish\"\nimport { BintrayPublisher } from \"electron-publish/out/BintrayPublisher\"\nimport { GitHubPublisher } from \"electron-publish/out/gitHubPublisher\"\nimport { MultiProgress } from \"electron-publish/out/multiProgress\"\nimport { ensureDir, outputFile, outputJson, readFile, writeFile } from \"fs-extra-p\"\nimport isCi from \"is-ci\"\nimport { safeDump } from \"js-yaml\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { WriteStream as TtyWriteStream } from \"tty\"\nimport * as url from \"url\"\nimport { PlatformSpecificBuildOptions, ReleaseInfo } from \"../configuration\"\nimport { Platform, Target } from \"../core\"\nimport { Packager } from \"../packager\"\nimport { ArtifactCreated } from \"../packagerApi\"\nimport { PlatformPackager } from \"../platformPackager\"\nimport { WinPackager } from \"../winPackager\"\n\nconst publishForPrWarning = \"There are serious security concerns with PUBLISH_FOR_PULL_REQUEST=true (see the  CircleCI documentation (https://circleci.com/docs/1.0/fork-pr-builds/) for details)\" +\n  \"\\nIf you have SSH keys, sensitive env vars or AWS credentials stored in your project settings and untrusted forks can make pull requests against your repo, then this option isn't for you.\"\n\nconst debug = _debug(\"electron-builder:publish\")\n\nexport class PublishManager implements PublishContext {\n  private readonly nameToPublisher = new Map<string, Publisher | null>()\n\n  private readonly taskManager: AsyncTaskManager\n\n  private readonly isPublish: boolean\n\n  readonly progress = (process.stdout as TtyWriteStream).isTTY ? new MultiProgress() : null\n\n  constructor(packager: Packager, private readonly publishOptions: PublishOptions, readonly cancellationToken: CancellationToken) {\n    this.taskManager = new AsyncTaskManager(cancellationToken)\n\n    const forcePublishForPr = process.env.PUBLISH_FOR_PULL_REQUEST === \"true\"\n    if (!isPullRequest() || forcePublishForPr) {\n      if (publishOptions.publish === undefined) {\n        if (process.env.npm_lifecycle_event === \"release\") {\n          publishOptions.publish = \"always\"\n        }\n        else {\n          const tag = getCiTag()\n          if (tag != null) {\n            log(`Tag ${tag} is defined, so artifacts will be published`)\n            publishOptions.publish = \"onTag\"\n          }\n          else if (isCi) {\n            log(\"CI detected, so artifacts will be published if draft release exists\")\n            publishOptions.publish = \"onTagOrDraft\"\n          }\n        }\n      }\n\n      const publishPolicy = publishOptions.publish\n      this.isPublish = publishPolicy != null && publishOptions.publish !== \"never\" && (publishPolicy !== \"onTag\" || getCiTag() != null)\n      if (this.isPublish && forcePublishForPr) {\n        warn(publishForPrWarning)\n      }\n    }\n    else if (publishOptions.publish !== \"never\") {\n      log(\"Current build is a part of pull request, publishing will be skipped\" +\n        \"\\nSet env PUBLISH_FOR_PULL_REQUEST to true to force code signing.\" +\n        `\\n${publishForPrWarning}`)\n    }\n\n    packager.addAfterPackHandler(async event => {\n      const packager = event.packager\n      if (event.electronPlatformName === \"darwin\") {\n        if (!event.targets.some(it => it.name === \"zip\")) {\n          return\n        }\n      }\n      else if (packager.platform === Platform.WINDOWS) {\n        if (!event.targets.some(it => isSuitableWindowsTarget(it, null))) {\n          return\n        }\n      }\n      else {\n        return\n      }\n\n      const publishConfigs = await getPublishConfigsForUpdateInfo(packager, await getPublishConfigs(packager, null, event.arch), event.arch)\n      if (publishConfigs == null || publishConfigs.length === 0) {\n        return\n      }\n\n      let publishConfig = publishConfigs[0]\n\n      if (packager.platform === Platform.WINDOWS && publishConfig.publisherName == null) {\n        const winPackager = packager as WinPackager\n        if (winPackager.isForceCodeSigningVerification) {\n          const publisherName = await winPackager.computedPublisherName.value\n          if (publisherName != null) {\n            publishConfig = {...publishConfig, publisherName}\n          }\n        }\n      }\n\n      await writeFile(path.join(packager.getResourcesDir(event.appOutDir), \"app-update.yml\"), safeDump(publishConfig))\n    })\n\n    packager.artifactCreated(event => this.taskManager.addTask(this.artifactCreated(event)))\n  }\n\n  private async artifactCreated(event: ArtifactCreated) {\n    const packager = event.packager\n    const target = event.target\n    const publishConfigs = event.publishConfig == null ? await getPublishConfigs(packager, target == null ? null : target.options, event.arch) : [event.publishConfig]\n\n    if (debug.enabled) {\n      debug(`artifactCreated: ${safeStringifyJson(event, new Set([\"packager\"]))},\\npublishConfigs: ${safeStringifyJson(publishConfigs)},\\nisPublish: ${this.isPublish}`)\n    }\n\n    const eventFile = event.file\n    if (publishConfigs == null) {\n      if (this.isPublish) {\n        debug(`${eventFile} is not published: no publish configs`)\n      }\n      return\n    }\n\n    if (this.isPublish) {\n      for (const publishConfig of publishConfigs) {\n        if (this.cancellationToken.cancelled) {\n          debug(`${eventFile} is not published: cancelled`)\n          break\n        }\n\n        const publisher = this.getOrCreatePublisher(publishConfig, packager)\n        if (publisher == null) {\n          debug(`${eventFile} is not published: publisher is null, ${safeStringifyJson(publishConfig)}`)\n          continue\n        }\n\n        if (eventFile == null) {\n          this.taskManager.addTask((publisher as HttpPublisher).uploadData(event.data!, event.arch || Arch.x64, event.safeArtifactName!))\n        }\n        else {\n          this.taskManager.addTask(publisher.upload(eventFile!, event.arch || Arch.x64, event.safeArtifactName))\n        }\n      }\n    }\n\n    if (target != null && eventFile != null && !this.cancellationToken.cancelled) {\n      if ((packager.platform === Platform.MAC && target.name === \"zip\") ||\n        (packager.platform === Platform.WINDOWS && isSuitableWindowsTarget(target, event))) {\n        this.taskManager.addTask(writeUpdateInfo(event, publishConfigs))\n      }\n    }\n  }\n\n  private getOrCreatePublisher(publishConfig: PublishConfiguration, platformPackager: PlatformPackager<any>): Publisher | null {\n    // to not include token into cache key\n    const providerCacheKey = safeStringifyJson(publishConfig)\n    let publisher = this.nameToPublisher.get(providerCacheKey)\n    if (publisher == null) {\n      publisher = createPublisher(this, platformPackager.info.metadata.version!, publishConfig, this.publishOptions)\n      this.nameToPublisher.set(providerCacheKey, publisher)\n      log(`Publishing to ${publisher}`)\n    }\n    return publisher\n  }\n\n  cancelTasks() {\n    this.taskManager.cancelTasks()\n    this.nameToPublisher.clear()\n  }\n\n  awaitTasks() {\n    return this.taskManager.awaitTasks()\n  }\n}\n\nexport async function getPublishConfigsForUpdateInfo(packager: PlatformPackager<any>, publishConfigs: Array<PublishConfiguration> | null, arch: Arch | null): Promise<Array<PublishConfiguration> | null> {\n  if (publishConfigs === null) {\n    return null\n  }\n\n  if (publishConfigs.length === 0) {\n    debug(\"getPublishConfigsForUpdateInfo: no publishConfigs, detect using repository info\")\n    // https://github.com/electron-userland/electron-builder/issues/925#issuecomment-261732378\n    // default publish config is github, file should be generated regardless of publish state (user can test installer locally or manage the release process manually)\n    const repositoryInfo = await packager.info.repositoryInfo\n    debug(`getPublishConfigsForUpdateInfo: ${safeStringifyJson(repositoryInfo)}`)\n    if (repositoryInfo != null && repositoryInfo.type === \"github\") {\n      const resolvedPublishConfig = await getResolvedPublishConfig(packager, {provider: repositoryInfo.type}, arch, false)\n      if (resolvedPublishConfig != null) {\n        debug(`getPublishConfigsForUpdateInfo: resolve to publish config ${safeStringifyJson(resolvedPublishConfig)}`)\n        return [resolvedPublishConfig]\n      }\n    }\n  }\n  return publishConfigs\n}\n\nasync function writeUpdateInfo(event: ArtifactCreated, _publishConfigs: Array<PublishConfiguration>) {\n  const packager = event.packager\n  const publishConfigs = await getPublishConfigsForUpdateInfo(packager, _publishConfigs, event.arch)\n  if (publishConfigs == null || publishConfigs.length === 0) {\n    return\n  }\n\n  const target = event.target!\n  let outDir = target.outDir\n  if (event.packager.platform === Platform.WINDOWS && target.name !== \"nsis\") {\n    outDir = path.join(outDir, target.name)\n    await ensureDir(outDir)\n  }\n\n  const version = packager.appInfo.version\n  const sha2 = new Lazy<string>(() => hashFile(event.file!, \"sha256\", \"hex\"))\n  const sha512 = new Lazy<string>(() => hashFile(event.file!, \"sha512\", \"base64\"))\n  const isMac = packager.platform === Platform.MAC\n\n  const releaseInfo: ReleaseInfo = {...packager.config.releaseInfo}\n  if (releaseInfo.releaseNotes == null) {\n    const releaseNotesFile = await packager.getResource(releaseInfo.releaseNotesFile, \"release-notes.md\")\n    const releaseNotes = releaseNotesFile == null ? null : await readFile(releaseNotesFile, \"utf-8\")\n    // to avoid undefined in the file, check for null\n    if (releaseNotes != null) {\n      releaseInfo.releaseNotes = releaseNotes\n    }\n  }\n  delete releaseInfo.releaseNotesFile\n\n  const createdFiles = new Set<string>()\n\n  for (const publishConfig of publishConfigs) {\n    if (publishConfig.provider === \"bintray\") {\n      continue\n    }\n\n    const channel = (publishConfig as GenericServerOptions).channel || \"latest\"\n\n    let dir = outDir\n    if (publishConfigs.length > 1 && publishConfig !== publishConfigs[0]) {\n      dir = path.join(outDir, publishConfig.provider)\n    }\n\n    if (isMac) {\n      const isGitHub = publishConfig.provider === \"github\"\n      // backward compatibility - write json file\n      const updateInfoFile = (isGitHub && outDir === dir) ? path.join(dir, \"github\", `${channel}-mac.json`) : path.join(dir, `${channel}-mac.json`)\n      if (!createdFiles.has(updateInfoFile)) {\n        createdFiles.add(updateInfoFile)\n        await outputJson(updateInfoFile, {\n          version,\n          releaseDate: new Date().toISOString(),\n          url: computeDownloadUrl(publishConfig, packager.generateName2(\"zip\", \"mac\", isGitHub), packager),\n        }, {spaces: 2})\n\n        packager.info.dispatchArtifactCreated({\n          file: updateInfoFile,\n          arch: null,\n          packager,\n          target: null,\n          publishConfig,\n        })\n      }\n    }\n\n    const updateInfoFile = path.join(dir, `${channel}${isMac ? \"-mac\" : \"\"}.yml`)\n    if (createdFiles.has(updateInfoFile)) {\n      continue\n    }\n\n    createdFiles.add(updateInfoFile)\n\n    const info: UpdateInfo = {\n      version,\n      releaseDate: new Date().toISOString(),\n      path: path.basename(event.file!),\n      sha512: await sha512.value, ...releaseInfo as UpdateInfo,\n    }\n\n    const packageFiles = event.packageFiles\n    if (packageFiles != null) {\n      const keys = Object.keys(packageFiles)\n      if (keys.length > 0) {\n        info.packages = {}\n        for (const arch of keys) {\n          info.packages[arch] = path.basename(packageFiles[arch])\n        }\n      }\n    }\n\n    if (event.safeArtifactName != null) {\n      info.githubArtifactName = event.safeArtifactName\n    }\n\n    if (packager.platform === Platform.WINDOWS) {\n      // backward compatibility\n      (info as any).sha2 = await sha2.value\n    }\n    await outputFile(updateInfoFile, safeDump(info))\n\n    // artifact should be uploaded only to designated publish provider\n    packager.info.dispatchArtifactCreated({\n      file: updateInfoFile,\n      arch: null,\n      packager,\n      target: null,\n      publishConfig,\n    })\n  }\n}\n\nexport function createPublisher(context: PublishContext, version: string, publishConfig: PublishConfiguration, options: PublishOptions): Publisher | null {\n  if (debug.enabled) {\n    debug(`create publisher: ${safeStringifyJson(publishConfig)}`)\n  }\n\n  const provider = publishConfig.provider\n  switch (provider) {\n    case \"github\":\n      return new GitHubPublisher(context, publishConfig, version, options)\n\n    case \"bintray\":\n      return new BintrayPublisher(context, publishConfig, version, options)\n\n    case \"generic\":\n      return null\n\n    default:\n      const clazz = requireProviderClass(provider)\n      return clazz == null ? null : new clazz(context, publishConfig)\n  }\n}\n\nfunction requireProviderClass(provider: string): any | null {\n  switch (provider) {\n    case \"github\":\n      return GitHubPublisher\n\n    case \"bintray\":\n      return BintrayPublisher\n\n    case \"generic\":\n      return null\n\n    default:\n      return require(`electron-publisher-${provider}`).default\n  }\n}\n\nexport function computeDownloadUrl(publishConfig: PublishConfiguration, fileName: string | null, packager: PlatformPackager<any>) {\n  if (publishConfig.provider === \"generic\") {\n    const baseUrlString = (publishConfig as GenericServerOptions).url\n    if (fileName == null) {\n      return baseUrlString\n    }\n\n    const baseUrl = url.parse(baseUrlString)\n    return url.format({...baseUrl as url.UrlObject, pathname: path.posix.resolve(baseUrl.pathname || \"/\", encodeURI(fileName))})\n  }\n\n  let baseUrl\n  if (publishConfig.provider === \"s3\") {\n    baseUrl = s3Url((publishConfig as S3Options))\n  }\n  else {\n    const gh = publishConfig as GithubOptions\n    baseUrl = `${githubUrl(gh)}/${gh.owner}/${gh.repo}/releases/download/${gh.vPrefixedTagName === false ? \"\" : \"v\"}${packager.appInfo.version}`\n  }\n\n  if (fileName == null) {\n    return baseUrl\n  }\n  return `${baseUrl}/${encodeURI(fileName)}`\n}\n\nexport async function getPublishConfigs(packager: PlatformPackager<any>, targetSpecificOptions: PlatformSpecificBuildOptions | null | undefined, arch: Arch | null): Promise<Array<PublishConfiguration> | null> {\n  let publishers\n\n  // check build.nsis (target)\n  if (targetSpecificOptions != null) {\n    publishers = targetSpecificOptions.publish\n    // if explicitly set to null - do not publish\n    if (publishers === null) {\n      return null\n    }\n  }\n\n  // check build.win (platform)\n  if (publishers == null) {\n    publishers = packager.platformSpecificBuildOptions.publish\n    if (publishers === null) {\n      return null\n    }\n  }\n\n  if (publishers == null) {\n    publishers = packager.config.publish\n    if (publishers === null) {\n      return null\n    }\n  }\n\n  if (publishers == null) {\n    let serviceName: PublishProvider | null = null\n    if (!isEmptyOrSpaces(process.env.GH_TOKEN)) {\n      serviceName = \"github\"\n    }\n    else if (!isEmptyOrSpaces(process.env.BT_TOKEN)) {\n      serviceName = \"bintray\"\n    }\n\n    if (serviceName != null) {\n      debug(`Detect ${serviceName} as publish provider`)\n      return [(await getResolvedPublishConfig(packager, {provider: serviceName}, arch))!]\n    }\n  }\n\n  if (publishers == null) {\n    return []\n  }\n\n  debug(`Explicit publish provider: ${safeStringifyJson(publishers)}`)\n  return await (BluebirdPromise.map(asArray(publishers), it => getResolvedPublishConfig(packager, typeof it === \"string\" ? {provider: it} : it, arch)) as Promise<Array<PublishConfiguration>>)\n}\n\nfunction isSuitableWindowsTarget(target: Target, event: ArtifactCreated | null) {\n  if (event != null && !event.isWriteUpdateInfo) {\n    return false\n  }\n\n  if (target.name === \"appx\" && target.options != null && (target.options as any).electronUpdaterAware) {\n    return true\n  }\n  return target.name === \"nsis\" || target.name.startsWith(\"nsis-\")\n}\n\nfunction expandPublishConfig(options: any, packager: PlatformPackager<any>, arch: Arch | null): void {\n  for (const name of Object.keys(options)) {\n    const value = options[name]\n    if (typeof value === \"string\") {\n      const expanded = packager.expandMacro(value, arch == null ? null : Arch[arch])\n      if (expanded !== value) {\n        options[name] = expanded\n      }\n    }\n  }\n}\n\nasync function getResolvedPublishConfig(packager: PlatformPackager<any>, options: PublishConfiguration, arch: Arch | null, errorIfCannot: boolean = true): Promise<PublishConfiguration | GithubOptions | BintrayOptions | null> {\n  options = Object.assign(Object.create(null), options)\n  expandPublishConfig(options, packager, arch)\n\n  let channelFromAppVersion: string | null = null\n  if ((options as any).channel == null && packager.config.detectUpdateChannel !== false) {\n    channelFromAppVersion = packager.appInfo.channel\n  }\n\n  const provider = options.provider\n  if (provider === \"generic\") {\n    const o = options as GenericServerOptions\n    if (o.url == null) {\n      throw new Error(`Please specify \"url\" for \"generic\" update server`)\n    }\n\n    if (channelFromAppVersion != null) {\n      (o as any).channel = channelFromAppVersion\n    }\n    return options\n  }\n\n  const providerClass = requireProviderClass(options.provider)\n  if (providerClass != null && providerClass.checkAndResolveOptions != null) {\n    await providerClass.checkAndResolveOptions(options, channelFromAppVersion)\n    return options\n  }\n\n  const isGithub = provider === \"github\"\n  if (!isGithub && provider !== \"bintray\") {\n    return options\n  }\n\n  let owner = isGithub ? (options as GithubOptions).owner : (options as BintrayOptions).owner\n  let project = isGithub ? (options as GithubOptions).repo : (options as BintrayOptions).package\n\n  if (isGithub && owner == null && project != null) {\n    const index = project.indexOf(\"/\")\n    if (index > 0) {\n      const repo = project\n      project = repo.substring(0, index)\n      owner = repo.substring(index + 1)\n    }\n  }\n\n  async function getInfo() {\n    const info = await packager.info.repositoryInfo\n    if (info != null) {\n      return info\n    }\n\n    const message = `Cannot detect repository by .git/config. Please specify \"repository\" in the package.json (https://docs.npmjs.com/files/package.json#repository).\\nPlease see https://electron.build/publishing-artifacts`\n    if (errorIfCannot) {\n      throw new Error(message)\n    }\n    else {\n      warn(message)\n      return null\n    }\n  }\n\n  if (!owner || !project) {\n    debug(`Owner or project is not specified explicitly for ${provider}, call getInfo: owner: ${owner}, project: ${project}`)\n    const info = await getInfo()\n    if (info == null) {\n      return null\n    }\n\n    if (!owner) {\n      owner = info.user\n    }\n    if (!project) {\n      project = info.project\n    }\n  }\n\n  if (isGithub) {\n    if ((options as GithubOptions).token != null && !(options as GithubOptions).private) {\n      warn('\"token\" specified in the github publish options. It should be used only for [setFeedURL](module:electron-updater/out/AppUpdater.AppUpdater+setFeedURL).')\n    }\n    return {owner, repo: project, ...options}\n  }\n  else {\n    return {owner, package: project, ...options}\n  }\n}"]}
