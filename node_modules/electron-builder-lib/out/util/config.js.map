{"version":3,"file":"config.js","sourceRoot":"","sources":["../../src/util/config.ts"],"names":[],"mappings":"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","sourcesContent":["import { asArray, DebugLogger, InvalidConfigurationError, log } from \"builder-util\"\nimport { statOrNull } from \"builder-util/out/fs\"\nimport { readJson } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { getConfig as _getConfig, loadParentConfig, orNullIfFileNotExist, ReadConfigRequest, validateConfig as _validateConfig } from \"read-config-file\"\nimport { deepAssign } from \"read-config-file/out/deepAssign\"\nimport { Configuration } from \"../configuration\"\nimport { reactCra } from \"../presets/rectCra\"\n\n// https://github.com/electron-userland/electron-builder/issues/1847\nfunction mergePublish(config: Configuration, configFromOptions: Configuration) {\n  // if config from disk doesn't have publish (or object), no need to handle, it will be simply merged by deepAssign\n  const publish = Array.isArray(config.publish) ? configFromOptions.publish : null\n  if (publish != null) {\n    delete (configFromOptions as any).publish\n  }\n\n  deepAssign(config, configFromOptions)\n\n  if (publish == null) {\n    return\n  }\n\n  const listOnDisk = config.publish as Array<any>\n  if (listOnDisk.length === 0) {\n    config.publish = publish\n  }\n  else {\n    // apply to first\n    Object.assign(listOnDisk[0], publish)\n  }\n}\n\nexport async function getConfig(projectDir: string, configPath: string | null, configFromOptions: Configuration | null | undefined, packageMetadata: Lazy<{ [key: string]: any } | null> = new Lazy(() => orNullIfFileNotExist(readJson(path.join(projectDir, \"package.json\"))))): Promise<Configuration> {\n  const configRequest: ReadConfigRequest = {packageKey: \"build\", configFilename: \"electron-builder\", projectDir, packageMetadata}\n  const configAndEffectiveFile = await _getConfig<Configuration>(configRequest, configPath)\n  const config = configAndEffectiveFile == null ? {} : configAndEffectiveFile.result\n  if (configFromOptions != null) {\n    mergePublish(config, configFromOptions)\n  }\n\n  if (configAndEffectiveFile != null) {\n    log.info({file: configAndEffectiveFile.configFile == null ? 'package.json (\"build\" field)' : configAndEffectiveFile.configFile}, \"loaded configuration\")\n  }\n\n  let extendsSpec = config.extends\n  if (extendsSpec == null && extendsSpec !== null) {\n    const metadata = await packageMetadata.value || {}\n    const devDependencies = metadata.devDependencies\n    const dependencies = metadata.dependencies\n    if ((dependencies != null && \"react-scripts\" in dependencies) || (devDependencies != null && \"react-scripts\" in devDependencies)) {\n      extendsSpec = \"react-cra\"\n      config.extends = extendsSpec\n    }\n    else if (devDependencies != null && \"electron-webpack\" in devDependencies) {\n      extendsSpec = \"electron-webpack/electron-builder.yml\"\n      config.extends = extendsSpec\n    }\n  }\n\n  if (extendsSpec == null) {\n    return deepAssign(getDefaultConfig(), config)\n  }\n\n  let parentConfig: Configuration | null\n  if (extendsSpec === \"react-cra\") {\n    parentConfig = await reactCra(projectDir)\n    log.info({preset: extendsSpec}, \"loaded parent configuration\")\n  }\n  else {\n    const parentConfigAndEffectiveFile = await loadParentConfig<Configuration>(configRequest, extendsSpec)\n    log.info({file: parentConfigAndEffectiveFile.configFile}, \"loaded parent configuration\")\n    parentConfig = parentConfigAndEffectiveFile.result\n  }\n\n  // electron-webpack and electrify client config - want to exclude some files\n  // we add client files configuration to main parent file matcher\n  if (parentConfig.files != null && config.files != null && (Array.isArray(config.files) || typeof config.files === \"string\") && Array.isArray(parentConfig.files) && parentConfig.files.length > 0) {\n    const mainFileSet = parentConfig.files[0]\n    if (typeof mainFileSet === \"object\" && (mainFileSet.from == null || mainFileSet.from === \".\")) {\n      mainFileSet.filter = asArray(mainFileSet.filter)\n      mainFileSet.filter.push(...asArray(config.files as any))\n      delete (config as any).files\n    }\n  }\n\n  return deepAssign(getDefaultConfig(), parentConfig, config)\n}\n\nfunction getDefaultConfig(): Configuration {\n  return {\n    directories: {\n      output: \"dist\",\n      buildResources: \"build\",\n    },\n  }\n}\n\nconst schemeDataPromise = new Lazy(() => readJson(path.join(__dirname, \"..\", \"..\", \"scheme.json\")))\n\nexport async function validateConfig(config: Configuration, debugLogger: DebugLogger) {\n  const extraMetadata = config.extraMetadata\n  if (extraMetadata != null) {\n    if (extraMetadata.build != null) {\n      throw new InvalidConfigurationError(`--em.build is deprecated, please specify as -c\"`)\n    }\n    if (extraMetadata.directories != null) {\n      throw new InvalidConfigurationError(`--em.directories is deprecated, please specify as -c.directories\"`)\n    }\n  }\n\n  // noinspection JSDeprecatedSymbols\n  if (config.npmSkipBuildFromSource === false) {\n    config.buildDependenciesFromSource = false\n  }\n\n  await _validateConfig(config, schemeDataPromise, (message, errors) => {\n    if (debugLogger.enabled) {\n      debugLogger.add(\"invalidConfig\", JSON.stringify(errors, null, 2))\n    }\n\n    return `${message}\n\nHow to fix:\n1. Open https://electron.build/configuration/configuration\n2. Search the option name on the page.\n  * Not found? The option was deprecated or not exists (check spelling).\n  * Found? Check that the option in the appropriate place. e.g. \"title\" only in the \"dmg\", not in the root.\n`\n  })\n}\n\nconst DEFAULT_APP_DIR_NAMES = [\"app\", \"www\"]\n\nexport async function computeDefaultAppDirectory(projectDir: string, userAppDir: string | null | undefined): Promise<string> {\n  if (userAppDir != null) {\n    const absolutePath = path.resolve(projectDir, userAppDir)\n    const stat = await statOrNull(absolutePath)\n    if (stat == null) {\n      throw new InvalidConfigurationError(`Application directory ${userAppDir} doesn't exists`)\n    }\n    else if (!stat.isDirectory()) {\n      throw new InvalidConfigurationError(`Application directory ${userAppDir} is not a directory`)\n    }\n    else if (projectDir === absolutePath) {\n      log.warn({appDirectory: userAppDir}, `Specified application directory equals to project dir â€” superfluous or wrong configuration`)\n    }\n    return absolutePath\n  }\n\n  for (const dir of DEFAULT_APP_DIR_NAMES) {\n    const absolutePath = path.join(projectDir, dir)\n    const packageJson = path.join(absolutePath, \"package.json\")\n    const stat = await statOrNull(packageJson)\n    if (stat != null && stat.isFile()) {\n      return absolutePath\n    }\n  }\n  return projectDir\n}"]}
